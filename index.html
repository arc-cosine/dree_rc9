<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6-5 DNS ê²Œì‹œíŒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Jua' rel='stylesheet'>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        #searchInput {
            width: 100%;
            max-width: 500px;
            padding: 12px 16px;
            margin: 20px auto;
            display: block;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #searchInput:focus {
            border-color: #6c63ff;
            outline: none;
            box-shadow: 0 0 5px rgba(108, 99, 255, 0.5);
        }
        .timestamp {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Jua';
            /*font-size: 22px;*/
        }
        html, body {
            height: 100%;
            background-color: #2e5e2e;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .auth-bar {
            background-color: #222;
            color: white;
            padding: 10px 20px;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .auth-bar button {
            background-color: #ffda58;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .sidebar {
            width: 220px;
            background-color: #333;
            color: white;
            padding-top: 40px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        .sidebar.closed {
            transform: translateX(-220px);
        }
        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.6rem;
            font-weight: bold;
        }
        .sidebar a,
        #authSection button {
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
            border: none;
            background-color: transparent;
            text-align: left;
            width: 100%;
        }
        .sidebar a:hover,
        #authSection button:hover,
        .sidebar a.active {
            background-color: #555;
        }
        /* ëª¨ë°”ì¼ ê¸°ì¤€: ì‚¬ì´ë“œë°” ê²¹ì¹˜ê¸° */
        .main-content {
            margin-left: 0;
            flex: 1;
            background-color: #2e5e2e;
            border: 15px solid #8b5a2b;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            overflow-y: auto;
            position: relative;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            z-index: 1;
        }
        .main-content.sidebar-closed {
            margin-left: 0 !important;
        }
        .sidebar-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: #ffda58;
            color: #222;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 1.2rem;
            z-index: 200;
            cursor: pointer;
        }
        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
            color: white;
        }
        .post-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .post-it {
            background-color: #fff8b3;
            color: #333;
            padding: 15px;
            width: 180px;
            height: 150px;
            cursor: pointer;
            border-radius: 8px;
            position: relative;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
            transform: rotate(calc(-5deg + 10deg * var(--rand)));
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-image: repeating-linear-gradient(
                    180deg,
                    transparent,
                    transparent 28px,
                    #e1de8d 29px
            );
            user-select: none;
        }
        .post-it:hover {
            transform: scale(1.05) rotate(calc(-5deg + 10deg * var(--rand)));
        }
        .pin {
            width: 16px;
            height: 16px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        #authSection {
            margin-top: auto;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #authSection button {
            background-color: #ffda58;
            color: #222;
            border-radius: 5px;
            font-size: 1rem;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.3s;
        }
        #authSection button:hover {
            background-color: #e6c850;
        }
        #userInfo {
            color: white;
            font-size: 0.9rem;
            text-align: center;
            word-break: break-word;
        }
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #ffda58;
            color: #222;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 101;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .modal-content h2 {
            margin-bottom: 15px;
        }
        .modal-content input,
        .modal-content textarea {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .modal-content button {
            background-color: #2e5e2e;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        .post-detail {
            display: none;
            background: white;
            color: black;
            padding: 40px;
            border-radius: 15px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            max-height: 90vh;
            user-select: text;
        }
        .likes-comments {
            margin-top: 15px;
        }

        #submitBtn {
            width : 100%;
        }
        .likes-comments button {
            margin-right: 10px;
            background: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1rem;
            user-select: none;
        }
        .action-buttons button {
            margin-right: 10px;
            background: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1rem;
            user-select: none;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ccc;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            cursor: pointer;
            line-height: 25px;
            text-align: center;
            padding: 0;
            user-select: none;
        }
    </style>
</head>
<body>

<!-- ğŸ”˜ ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
<button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
<script>
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const main = document.getElementById("mainContent");
        sidebar.classList.toggle("closed");
        main.classList.toggle("sidebar-closed");
    }
</script>
<!-- ê¸°ì¡´ ì‚¬ì´ë“œë°” -->
<div class="sidebar closed" id="sidebar">
    <h2>6-5 DNS</h2>
    <a id="menu-home" onclick="switchPage('home'); toggleSidebar()">ğŸ  í™ˆ</a>
    <a id="menu-popular" onclick="switchPage('popular'); toggleSidebar()">ğŸ”¥ ì¸ê¸°ìˆœ</a>
    <a id="menu-official" onclick="switchPage('official'); toggleSidebar()">ğŸ“¢ ê³µì‹ê¸€</a>
    <a id="menu-new" onclick="switchPage('new'); toggleSidebar()">â“ì¤€ë¹„ì¤‘</a>
    <a id="menu-admin" onclick="location.href = './admin.html';" hidden> ğŸ› ï¸ ê´€ë¦¬ì í˜ì´ì§€</a>
    <div id="authSection">
        <br /><br /><a href="https://www.youtube.com/watch?v=jfbnnLQaPEE&list=RDjfbnnLQaPEE&start_radio=1">Made by. Arin<br />@RC9 Studio</a>
        <div style="font-size : 16px" id="userInfo"></div>
        <button id="loginBtn" onclick="signInWithGoogle()">Google ë¡œê·¸ì¸</button>
        <button id="logoutBtn" onclick="signOut()" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="main-content sidebar-closed" id="mainContent">
    <!-- ì´í•˜ ê¸°ì¡´ ì½”ë“œ ë™ì¼ -->
    <h1>6-5 DNS ê²Œì‹œíŒ</h1>
    <!--    <input-->
    <!--            type="text"-->
    <!--            id="searchInput"-->
    <!--            placeholder="ì œëª©ìœ¼ë¡œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”"-->
    <!--    />-->
    <div class="post-grid" id="postGrid"></div>
    <button class="fab" onclick="openModal()">+</button>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content">
        <h2 id="modalTitle">ê¸€ì“°ê¸°</h2>
        <input type="text" id="titleInput" placeholder="ì œëª©" required />
        <input type="url" id="imageInput" placeholder="ì´ë¯¸ì§€/ìœ íŠœë¸Œ ë™ì˜ìƒ ë§í¬ (ì„ íƒ)" />
        <textarea id="contentInput" placeholder="ë‚´ìš© ì…ë ¥" rows="5"></textarea>
        <div style="margin-top: 10px;">
            <label for="mealDate">ğŸ± ê¸‰ì‹ ì¶”ê°€: </label>
            <input type="date" id="mealDate" />
            <button onclick="addMealToContent()">ì¶”ê°€</button>
            <br />
            <br />
            <hr>
        </div>
        <div style="margin-top: 10px;">
            <!--      <label class="flex items-center mt-2">-->
            <!--        <input type="checkbox" id="isOfficialPost" class="mr-2"> ê³µì‹ ê¸€ë¡œ ë“±ë¡-->
            <!--      </label>-->
        </div>
        <button id="submitBtn" onclick="submitPost()">ì˜¬ë¦¬ê¸°</button>
    </div>
</div>

<div class="post-detail" id="postDetail"></div>
<!-- ì‹ ê³  ëª¨ë‹¬ -->
<!-- HTML ë¶€ë¶„ -->

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    emailjs.init("WPR5GJnYFNbdzpDoh");
    function closeDetail() {
        document.getElementById("postDetail").style.display = "none";
        editingPostId = null;
    }
    // ì‹ ê³  ëŒ€ìƒ ì •ë³´ ì €ì¥ìš© ì „ì—­ ë³€ìˆ˜
    let reportingPost = null;

    function openReportModal(postId, title) {
        closeDetail();
        reportingPost = { id: postId, title };
        document.getElementById("reportReason").value = "";
        document.getElementById("reportModal").style.display = "block";
    }


    function submitReport() {
        const reason = document.getElementById("reportReason").value.trim();
        if (!reason) {
            alert("ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        if (!currentUser || !reportingPost) {
            alert("ì‹ ê³  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const templateParams = {
            post_title: reportingPost.title,
            post_id: reportingPost.id,
            reason: reason,
            reporter: currentUser.displayName || currentUser.email || "ì•Œ ìˆ˜ ì—†ìŒ",
            reporter_email: currentUser.email || "ì—†ìŒ" ,
            email : "lvc.app.center@gmail.com"
        };

        emailjs.send('service_2mhgog9', 'template_mmrhzsu', templateParams, 'WPR5GJnYFNbdzpDoh')
            .then(() => {
                alert("ì‹ ê³ ê°€ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("reportModal").style.display = "none";
                // document.getElementById("detailModal").style.display = "none";
            })
            .catch(error => {
                console.error("ì‹ ê³  ì „ì†¡ ì‹¤íŒ¨:", error);
                alert("ì‹ ê³  ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        // â† ì´ ë‹«ëŠ” ì¤‘ê´„í˜¸ê°€ ë°˜ë“œì‹œ í•„ìš”í•¨

    }
</script>
<!-- ì‹ ê³  ëª¨ë‹¬ -->
<!-- ê¸°ì¡´ HTML ê·¸ëŒ€ë¡œ ìœ ì§€ -->
<div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; padding:20px; max-width:400px; margin:100px auto; border-radius:10px; position:relative;">
        <h3>ì‹ ê³  ì‚¬ìœ  ì…ë ¥</h3>
        <textarea id="reportReason" style="width:100%; height:100px;"></textarea>
        <br />
        <button onclick="submitReport()">ì œì¶œ</button>
        <button onclick="document.getElementById('reportModal').style.display = 'none';">ì·¨ì†Œ</button>
    </div>
</div>

<!-- ì¶”ê°€ CSS -->
<style>
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #reportModal button {
        background-color: #FFDA58;
        color: #1a1a1a;
        font-family: 'Jua', sans-serif; /* ì£¼ì•„ì²´ ì ìš© */
        font-weight: 400;
        border: none;
        border-radius: 10px;
        padding: 10px 16px; /* ì¡°ê¸ˆ ì‘ê²Œ */
        font-size: 15px;    /* ì¡°ê¸ˆ ì‘ê²Œ */
        min-width: 90px;    /* ë„ˆë¹„ ì‚´ì§ ì¤„ì„ */
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        transition: transform 0.08s ease, box-shadow 0.12s ease;
    }

    #reportModal button:active {
        transform: translateY(1px) scale(0.98);
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    /* ëª¨ë‹¬ ë‚´ë¶€ ì •ë ¬ */
    #reportModal > div {
        width: 90%;
        max-width: 400px;
        box-sizing: border-box;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 480px) {
        #reportModal > div {
            margin: auto 16px;
            width: calc(100% - 32px);
            padding: 16px;
        }
        #reportModal textarea {
            height: 140px;
            font-size: 15px;
        }
        #reportModal button {
            width: 100%;
            font-size: 16px;
            padding: 12px;
            margin-top: 8px;
        }
    }
</style>
<script src="./ban.js">
</script>
<script>
    window.onload = function () {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const formattedToday = `${yyyy}-${mm}-${dd}`;
        document.getElementById('mealDate').value = formattedToday;
    };
</script>

<script>
    let userIp = "0.0.0.0";

    fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => userIp = data.ip)
        .catch(err => console.warn("IP ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));

    // Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyBfXN5Gy6KX1ThZ92zDY7MXrMMzMF2Ceqo",
        authDomain: "boofuck-dns.firebaseapp.com",
        databaseURL:
            "https://boofuck-dns-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "boofuck-dns",
        storageBucket: "boofuck-dns.firebasestorage.app",
        messagingSenderId: "594205078724",
        appId: "1:594205078724:web:c364d1ba8cc2bd6d140591",
        measurementId: "G-1EX9H2KHDL",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentPage = "home";
    const likedSet = new Set();
    let currentUser = null;
    let editingPostId = null;

    // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ UI ë³€ê²½
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        const userInfo = document.getElementById("userInfo");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        if (user) {
            const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
            const isAdmin = adminUIDs.includes(user.uid);
            const displayName = user.displayName || user.email;
            userInfo.textContent = `${displayName}${isAdmin ? " (ê´€ë¦¬ì)" : ""}`;
            loginBtn.style.display = "none";
            logoutBtn.style.display = "block";
            const adminBtn = document.getElementById("menu-admin");
            if (isAdmin) {
                adminBtn.style.display = "block";
            } else {
                adminBtn.style.display = "none";
            }

        } else {
            userInfo.textContent = "ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.";
            loginBtn.style.display = "block";
            logoutBtn.style.display = "none";
        }
    });
    // jsonbinì—ì„œ ì°¨ë‹¨ ì´ë©”ì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ì˜ˆì œ
    async function fetchBlockedEmails() {
        const response = await fetch('https://api.jsonbin.io/v3/b/68989c58ae596e708fc6af4a/latest', {
            headers: {
                'X-Master-Key': '$2a$10$v8MnmFSL/GoywF.qohAheOJAFCQDPmBW20gtMMHbxdN/zrkvUU1MW'
            }
        });
        const data = await response.json();
        // ë°ì´í„° êµ¬ì¡°ì— ë”°ë¼ ì¡°ì • í•„ìš” (ì˜ˆ: data.record.blockedEmails)
        return data.record.blockedEmails || [];
    }

    // Firebase ì´ˆê¸°í™”ëŠ” ì´ë¯¸ ë˜ì–´ ìˆë‹¤ê³  ê°€ì •

    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            try {
                const blockedEmails = await fetchBlockedEmails();
                const userEmail = user.email.toLowerCase();
                const isBlocked = blockedEmails.some(email => email.toLowerCase() === userEmail);

                if (isBlocked) {
                    alert('ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    await firebase.auth().signOut();
                    // ì›í•œë‹¤ë©´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë„ ê°€ëŠ¥
                    // window.location.href = '/login.html';
                } else {
                    // ì •ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬
                    console.log('ì •ìƒ ì‚¬ìš©ì:', userEmail);
                }
            } catch (error) {
                console.error('ì°¨ë‹¨ ì´ë©”ì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:', error);
            }
        }
    });


    // êµ¬ê¸€ ë¡œê·¸ì¸
    function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(alert);
    }

    const postListElement = document.getElementById('postList');
    const searchInput = document.getElementById('searchInput');

    let allPosts = [];

    // ğŸ”¥ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    db.ref("posts").on("value", (snapshot) => {
        const data = snapshot.val();
        allPosts = [];

        for (let id in data) {
            allPosts.push({
                id: id,
                ...data[id],
            });
        }

    });

    // // ğŸ” ë Œë”ë§ + ê²€ìƒ‰
    // function renderPosts(posts) {
    //   // postListElement.innerHTML = "";
    //   posts.forEach((post) => {
    //     const li = document.createElement("li");
    //     li.innerHTML = `<strong>${post.title}</strong><br>${post.content}`;
    //     postListElement.appendChild(li);
    //   });
    // }



    // ë¡œê·¸ì•„ì›ƒ
    function signOut() {
        auth.signOut().catch(alert);
    }

    // í˜ì´ì§€ ì „í™˜ ë° ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    async function switchPage(page) {
        const postList = document.getElementById("postGrid");
        postList.innerHTML = "";

        if (page === "official") {
            const snapshot = await db.ref("posts").once("value");
            const data = snapshot.val() || {};

            let allPosts = Object.entries(data).flatMap(([board, posts]) =>
                Object.entries(posts).map(([id, post]) => ({
                    id,
                    ...post,
                }))
            );

            // âœ… ì´ ë¶€ë¶„ì„ ì¶”ê°€í•˜ì—¬ ë°ì´í„°ê°€ ìœ íš¨í•œì§€ ë¨¼ì € í™•ì¸í•©ë‹ˆë‹¤.
            allPosts = allPosts.filter(post => post && typeof post === 'object');

            allPosts = await Promise.all(
                allPosts.map(async (post) => {
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;
                    return { ...post, commentCount };
                })
            );

            // í•„í„°ë§ ì „ì— ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ë¨¼ì € ìˆ˜í–‰í–ˆìœ¼ë¯€ë¡œ, ì´ í•„í„°ëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
            allPosts = allPosts.filter(
                (post) => post.title?.includes("[ê³µì‹]") || post.content?.includes("[ê³µì‹]")
            );

            allPosts.sort((a, b) => (b.likes || 0) + (b.commentCount || 0) - (a.likes || 0) - (a.commentCount || 0));
            allPosts.forEach(createPostCard);
        }   if (page === "popular") {
            // ëª¨ë“  ê²Œì‹œíŒ ê¸€ í•©ì³ì„œ ì¸ê¸°ê¸€ ê¸°ì¤€ ì •ë ¬
            const boards = ["home", "new", "official"];
            let allPosts = [];

            for (const board of boards) {
                const snapshot = await db.ref(`posts/${board}`).once("value");
                const data = snapshot.val() || {};
                const posts = Object.values(data);
                allPosts = allPosts.concat(posts);
            }

            // ëŒ“ê¸€ ìˆ˜ í¬í•¨
            allPosts = await Promise.all(
                allPosts.map(async (post) => {
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;
                    return { ...post, commentCount };
                })
            );

            // ì¢‹ì•„ìš” + ëŒ“ê¸€ ìˆ˜ í•©ì‚° ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            allPosts.sort(
                (a, b) => (b.likes || 0) + (b.commentCount || 0) - (a.likes || 0) - (a.commentCount || 0)
            );

            allPosts.forEach(createPostCard);
        } else {
            // íŠ¹ì • ê²Œì‹œíŒ ê¸€ ë¡œë”©
            const snapshot = await db.ref(`posts/${page}`).once("value");
            const data = snapshot.val() || {};
            let posts = Object.values(data);

            posts = await Promise.all(
                posts.map(async (post) => {
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;
                    return { ...post, commentCount };
                })
            );

            posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            posts.forEach(createPostCard);
        }

        document.querySelectorAll(".sidebar a").forEach((a) => a.classList.remove("active"));
        const activeLink = document.getElementById(`menu-${page}`);
        if (activeLink) activeLink.classList.add("active");
    }

    //


    // í¬ìŠ¤íŠ¸ì‡ ì¹´ë“œ ìƒì„± (ì‘ì„±ì ë…¸ì¶œ X)
    function createPostCard(post) {
        const card = document.createElement("div");
        card.className = "post-it";
        card.style.setProperty("--rand", Math.random().toFixed(100));
        card.innerHTML = `<div class="pin"></div>${post.title}`;
        card.onclick = () => showDetail(post);
        document.getElementById("postGrid").appendChild(card);
    }

    // ìƒˆ ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸°
    function openModal() {
        if (!currentUser) return alert("ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        if (currentPage === "official")
            return alert("ê³µì‹ê²Œì‹œíŒì— ê²Œì‹œë¬¼ ê¸€ì„ ì˜¬ë¦¬ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        editingPostId = null; // ìƒˆ ê¸€ì“°ê¸° ìƒíƒœ
        document.getElementById("modalTitle").textContent = "ê¸€ì“°ê¸°";
        document.getElementById("submitBtn").textContent = "ì˜¬ë¦¬ê¸°";
        document.getElementById("titleInput").value = "";
        document.getElementById("contentInput").value = "";
        document.getElementById("imageInput").value = "";
        document.getElementById("writeModal").style.display = "flex";
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function (event) {
        const modal = document.getElementById("writeModal");
        if (event.target === modal) modal.style.display = "none";
    };

    // ê¸€ì“°ê¸° or ìˆ˜ì • ì œì¶œ
    function submitPost() {
        const titleInput = document.getElementById("titleInput");
        const contentInput = document.getElementById("contentInput");
        const imageInput = document.getElementById("imageInput");
        const isOfficialPost = document.getElementById("isOfficialPost");
        const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
        const isOfficial = isOfficialPost?.checked && adminUIDs.includes(auth.currentUser.uid);
        const title = isOfficial
            ? `ğŸ“¢ [ê³µì‹] ${titleInput.value.trim()}`
            : titleInput.value.trim();
        const content = contentInput.value.trim();
        const image = imageInput.value.trim();

        if (!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        const isAdmin = adminUIDs.includes(auth.currentUser.uid);


        //     async function checkWithGemini(text) {
        //       const API_KEY = "AIzaSyDSaoFO171HN6tx04abY3Em28ngIlxtk18";
        //       const MODEL_NAME = "gemini-2.0-flash";
        //
        //       // ê²€ì—´ìš© ì§ˆë¬¸ ì˜ˆì‹œ â€” ë¶€ì ì ˆí•œ ë‚´ìš©ì¸ì§€ yes/noë¡œ ë‹µë³€ ìš”ì²­
        //       const prompt = `ì•„ë˜ ë¬¸ì¥ì´ ë¶€ì ì ˆí•˜ê±°ë‚˜ ìš•ì„¤, ê³µê²©ì ì¸ í‘œí˜„ì„ í¬í•¨í•˜ëŠ”ì§€ 'yes' ë˜ëŠ” 'no'ë¡œë§Œ ëŒ€ë‹µí•´ì¤˜:\n\n${text}`;
        //
        //       try {
        //         const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
        //           method: "POST",
        //           headers: { "Content-Type": "application/json" },
        //           body: JSON.stringify({
        //             contents: [{
        //               parts: [{
        //                 text: prompt
        //               }]
        //             }]
        //           })
        //         });
        //
        //         const data = await res.json();
        //         const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text.toLowerCase();
        //
        //         // "yes" í¬í•¨í•˜ë©´ ë¶€ì ì ˆ íŒë‹¨
        //         return reply.includes("yes");
        //         console.log(reply);
        // } catch (error) {
        //         console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
        //         // ì˜¤ë¥˜ì‹œ ì•ˆì „í•˜ê²Œ ë¶€ì ì ˆ ì²˜ë¦¬ ì•ˆí•¨(ì›í•˜ëŠ” ëŒ€ë¡œ ìˆ˜ì • ê°€ëŠ¥)
        //         return false;
        //       }
        //     }
        //  checkWithGemini((content)
        if (!isAdmin) {
            for (let word of bannedWords) {
                if (title.includes(word) || content.includes(word)) {
                    alert(`ê¸ˆì§€ì–´ "${word}"ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê²Œì‹œê¸€ì„ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }
            }
        }

        const timestamp = Date.now();

        if (editingPostId !== null) {
            if (!title.includes(" (ìˆ˜ì •ë¨)")) title += " (ìˆ˜ì •ë¨)";
            db.ref(`posts/${currentPage}/${editingPostId}`)
                .once("value")
                .then((snapshot) => {
                    const oldPost = snapshot.val();
                    if (!oldPost) return alert("ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    const updatedPost = {
                        ...oldPost,
                        title,
                        content,
                        image,
                        timestamp
                    };
                    db.ref(`posts/${currentPage}/${editingPostId}`).set(updatedPost);
                    switchPage(currentPage);
                    document.getElementById("writeModal").style.display = "none";
                });
        } else {
            const id = Date.now();
            const author = currentUser.displayName || currentUser.email || "ìµëª…";
            const post = {
                id,
                title,
                content,
                image,
                likes: 0,
                author,
                timestamp,
                authorUid: currentUser.uid,
                views: 0,  // âœ… ì¡°íšŒìˆ˜ í•„ë“œ ì¶”ê°€
                ip: userIp  // âœ… ì €ì¥,
            };
            db.ref(`posts/${currentPage}/${id}`).set(post);
            switchPage(currentPage);
            document.getElementById("writeModal").style.display = "none";
        }

        titleInput.value = "";
        contentInput.value = "";
        imageInput.value = "";
    }

    function renderPosts(posts) {
        posts.forEach(post => {
            const postDiv = document.createElement("div");
            postDiv.className = "post";

            const title = document.createElement("h3");
            title.textContent = post.title || "(ì œëª© ì—†ìŒ)";
            postDiv.appendChild(title);

            const content = document.createElement("p");
            content.textContent = post.content || "";
            postDiv.appendChild(content);

            const author = document.createElement("small");
            author.textContent = post.author || "";
            postDiv.appendChild(author);

            postsDiv.appendChild(postDiv);
        });
    }
    // searchInput.addEventListener("input", function () {
    //   const keyword = searchInput.value.toLowerCase();
    //   const filtered = allPosts.filter(post =>
    //           post.title && post.title.toLowerCase().includes(keyword)
    //   );
    //   renderPosts(filtered);
    // });
    // ğŸ” ê²€ìƒ‰ ì´ë²¤íŠ¸
    // ë¯¸ë””ì–´ ë Œë”ë§ (ì´ë¯¸ì§€, ë™ì˜ìƒ, ì˜¤ë””ì˜¤, ìœ íŠœë¸Œ)
    function renderMedia(url) {
        const ext = url.split(".").pop().toLowerCase();
        const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/;
        const match = url.match(ytRegex);
        if (match && match[1]) {
            return `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${match[1]}" frameborder="0" allowfullscreen style="margin:10px 0;"></iframe>`;
        }
        if (["mp4", "m4a"].includes(ext)) {
            return `<video controls style="max-width:100%; margin:10px 0;"><source src="${url}" type="video/${ext}">Not supported</video>`;
        }
        if (["mp3", "wav"].includes(ext)) {
            return `<audio controls style="width:100%; margin:10px 0;"><source src="${url}" type="audio/${ext}">Not supported</audio>`;
        }
        return `<img src="${url}" style="max-width:100%; margin:10px 0;">`;
    }

    // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° (ì‘ì„±ì í‘œì‹œ, ë³¸ë¬¸ ìˆ˜ì • ê°€ëŠ¥)
    async function showDetail(post) {
        const postRef = db.ref(`posts/${currentPage}/${post.id}`);

        try {
            let shouldIncreaseView = false;

            if (currentUser) {
                // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì
                const viewRef = db.ref(`views/${post.id}/${currentUser.uid}`);
                const viewSnapshot = await viewRef.once("value");
                if (!viewSnapshot.exists()) {
                    await viewRef.set(true);
                    shouldIncreaseView = true;
                }
            } else {
                // ë¹„íšŒì› ì‚¬ìš©ìì˜ ì¡°íšŒ ê¸°ë¡ì€ localStorageì— ì €ì¥
                const viewedPosts = JSON.parse(localStorage.getItem("viewedPosts") || "{}");
                if (!viewedPosts[post.id]) {
                    viewedPosts[post.id] = true;
                    localStorage.setItem("viewedPosts", JSON.stringify(viewedPosts));
                    shouldIncreaseView = true;
                }
            }

            // ì¡°íšŒìˆ˜ ì¦ê°€ (ìµœì´ˆ 1íšŒë§Œ)
            if (shouldIncreaseView) {
                await postRef.child('views').transaction(current => (current || 0) + 1);
            }

            // ìµœì‹  ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            const snapshot = await postRef.once("value");
            if (snapshot.exists()) {
                post = snapshot.val();
            }


            const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
            const isAdmin = currentUser && adminUIDs.includes(currentUser.uid);
            const deleteBtn = isAdmin ? `<button onclick="deletePost(${post.id})" style="float:right; color:red;">ğŸ—‘ï¸ ì‚­ì œ</button>` : "";
            const detail = document.getElementById("postDetail");
            const date = post.timestamp
                ? new Date(post.timestamp).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
                : "ì•Œ ìˆ˜ ì—†ìŒ";

            const timestampHtml = `<div class="timestamp"><b>ì‘ì„± ì‹œê°:</b> ${date}</div>`;
            const maskedIp = post.ip
                ? post.ip.split('.').slice(0, 2).join('.') + '.*.*'
                : '?.?.*.*';
            // ê¸°ì¡´ ìƒì„¸ HTML ì•ˆì— ì‚½ì…
            function formatAuthorName(rawName) {
                const match = rawName.match(/^605\d{2}(.*)$/);
                return match ? match[1].trim() : rawName;
            }
            function openReportModal(postId, title) {
                closeDetail();
                reportingPost = { id: postId, title };
                document.getElementById("reportReason").value = "";
                document.getElementById("reportModal").style.display = "block";
            }
            detail.innerHTML = `
        <button class="close-btn" onclick="closeDetail()">Ã—</button>
        <h2>${escapeHtml(post.title)}</h2>
        ${deleteBtn}
        ${post.image ? renderMedia(post.image) : ""}
        <p style="white-space: pre-wrap;">${escapeHtml(post.content)}</p><br />
        <div style="font-size : 15px  "> ì¡°íšŒìˆ˜ ${post.views || 0}íšŒ<br /><b>ì‘ì„±ì:</b> ${escapeHtml(formatAuthorName(post.author || "ìµëª…"))} (${maskedIp})</div>
        ${timestampHtml}
        <div style="margin-top: 10px;" class="action-buttons">
        <button id="like-btn-${post.id}" onclick="likePost(${post.id})">â¤ï¸ ì¢‹ì•„ìš” (<span id="like-count-${post.id}">${post.likes || 0}</span>)</button>
  <button onclick="navigator.clipboard.writeText(\`${window.location.origin}${window.location.pathname}?post=${post.timestamp}\`).then(() => alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));">ğŸ”— ê³µìœ í•˜ê¸°</button>
    <button onclick="openReportModal('${post.id}', '${post.title.replace(/'/g, "\\'")}')">ğŸš¨ ì‹ ê³ í•˜ê¸°</button>
  </div>
        <div class="likes-comments">
         <div style="margin-top:20px;">
          <h3>ğŸ’¬ ëŒ“ê¸€</h3>
          <div id="comments-${post.id}" style="margin-bottom: 10px;"></div>
          <input id="comment-input-${post.id}" type="text" placeholder="ëŒ“ê¸€ ì…ë ¥" style="width: 80%; padding: 5px;" />
          <button onclick="addComment(${post.id})" style="padding: 5px 10px;">ì‘ì„±</button>
        </div>
        </div>

      `;
            detail.style.display = "block";
            renderComments(post.id);
        } catch (error) {
            console.error("ì¡°íšŒìˆ˜ ì¦ê°€ ì¤‘ ì˜¤ë¥˜:", error);
            alert("ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (XSS ë°©ì§€)
    function escapeHtml(text) {
        if (!text) return "";
        return text
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ì¢‹ì•„ìš” ëˆ„ë¥´ê¸°
    function likePost(id) {
        if (!currentUser) return alert("ë¡œê·¸ì¸ í›„ ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        if (likedSet.has(id)) return alert("ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ì–´ìš”!");
        likedSet.add(id);

        // í˜„ì¬ í˜ì´ì§€ê°€ ì¸ê¸°ê¸€ì¼ ê²½ìš°, ê° ê²Œì‹œíŒ ì¤‘ ì–´ëŠ ê²ƒì¸ì§€ ì°¾ì•„ì•¼ í•¨
        // ê°„ë‹¨íˆ í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ìœ¼ë¡œë§Œ ì²˜ë¦¬ (ë³µì¡ë„ ê³ ë ¤)
        const ref = db.ref(`posts/${currentPage}/${id}/likes`);
        ref
            .transaction((currentLikes) => {
                return (currentLikes || 0) + 1;
            })
            .then(() => {
                // ì¢‹ì•„ìš” ì¹´ìš´íŠ¸ ì¦‰ì‹œ UI ë°˜ì˜
                const likeCountSpan = document.getElementById(`like-count-${id}`);
                if (likeCountSpan) {
                    likeCountSpan.innerText = Number(likeCountSpan.innerText) + 1;
                }
                switchPage(currentPage);
            });
    }

    // ëŒ“ê¸€ ì‘ì„± (ëŒ“ê¸€ì€ { author, text } ê°ì²´ë¡œ ì €ì¥)
    function addComment(id) {
        if (!currentUser) return alert("ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.");
        const input = document.getElementById(`comment-input-${id}`);
        const text = input.value.trim();
        if (!text) return;
            for (let word of bannedWords) {
                if (text.includes(word) || text.includes(word)) {
                    alert(`ê¸ˆì§€ì–´ "${word}"ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê²Œì‹œê¸€ì„ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
            }
        }
        const commentData = {
            author: currentUser.displayName || currentUser.email || "ìµëª…",
            text,
        };

        db.ref(`comments/${id}`).push(commentData).then(() => {
            input.value = "";
            renderComments(id);
        });
    }

    // ëŒ“ê¸€ ë‹¤ì‹œ ë Œë” (ì‹¤ì œë¡œ ìƒì„¸ë³´ê¸°ì—ì„œë§Œ í˜¸ì¶œë¨)
    function renderComments(postId) {
        function formatAuthorName(rawName) {
            const match = rawName.match(/^605\d{2}(.*)$/);
            return match ? match[1].trim() : rawName;
        }
        const commentsRef = db.ref(`comments/${postId}`);
        commentsRef.off(); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
        commentsRef.on("value", (snapshot) => {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.innerHTML = "";

            snapshot.forEach((childSnapshot) => {
                const comment = childSnapshot.val();
                const key = childSnapshot.key;

                const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
                const isAdmin = currentUser && adminUIDs.includes(currentUser.uid);
                const isAuthor = currentUser && comment.uid === currentUser.uid;
                const showDelete = isAdmin || isAuthor;

                const commentElement = document.createElement("div");
                commentElement.innerHTML = `
          <b>${escapeHtml(formatAuthorName(comment.author || "ìµëª…"))}: ${escapeHtml(comment.text || "")}
          ${showDelete ? `<button onclick="deleteComment(${postId}, '${key}')" style="color:red; float:right;">ì‚­ì œ</button>` : ""}
        `;
                commentsDiv.appendChild(commentElement);
            });
        });
    }

    function deleteComment(postId, commentId) {
        if (confirm("ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref(`comments/${postId}/${commentId}`).remove();
        }
    }

    function deletePost(postId) {
        if (!confirm("ì •ë§ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        db.ref(`posts/${currentPage}/${postId}`).remove().then(() => {
            closeDetail();
            switchPage(currentPage); // ìƒˆë¡œê³ ì¹¨
        });
    }


    // ìˆ˜ì • ì‹œì‘: ìƒì„¸ë³´ê¸° ëª¨ë‹¬ì—ì„œ ìˆ˜ì • ë²„íŠ¼ ëˆ„ë¥´ë©´ ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸° + ê¸°ì¡´ ë‚´ìš© ì„¸íŒ…
    function startEditPost(postId) {
        if (!currentUser) return alert("ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        // í˜„ì¬ í˜ì´ì§€ì—ì„œ í•´ë‹¹ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        db.ref(`posts/${currentPage}/${postId}`)
            .once("value")
            .then((snapshot) => {
                const post = snapshot.val();
                if (!post) return alert("ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                if (
                    !(
                        currentUser.uid === post.authorUid ||
                        currentUser.email === post.author
                    )
                ) {
                    return alert("ë³¸ì¸ ê¸€ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                }
                editingPostId = postId;
                document.getElementById("modalTitle").textContent = "ê¸€ ìˆ˜ì •";
                document.getElementById("submitBtn").textContent = "ìˆ˜ì •ì™„ë£Œ";
                document.getElementById("titleInput").value = post.title.replace(
                    " (ìˆ˜ì •ë¨)",
                    ""
                );
                document.getElementById("contentInput").value = post.content;
                document.getElementById("imageInput").value = post.image || "";
                document.getElementById("writeModal").style.display = "flex";
                closeDetail();
            });
    }

    // ì´ˆê¸° í˜ì´ì§€ ë¡œë”©
</script>
<script>
    const API_KEY = "ecdd5e02250c425885ffc2da5742019b";
    const ATPT_OFCDC_SC_CODE = "B10";
    const SD_SCHUL_CODE = "7091380";

    function addMealToContent() {
        const dateInput = document.getElementById("mealDate");
        const contentInput = document.getElementById("contentInput");

        if (!dateInput.value) {
            alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const date = new Date(dateInput.value);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        const fullDate = `${y}${m}${d}`;

        const url = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${API_KEY}&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}&SD_SCHUL_CODE=${SD_SCHUL_CODE}&MLSV_YMD=${fullDate}&Type=json`;

        fetch(url)
            .then(res => res.json())
            .then(json => {
                if (!json.mealServiceDietInfo || !json.mealServiceDietInfo[1]) {
                    throw new Error("ì„ íƒí•œ ë‚ ì§œì— ê¸‰ì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                const meal = json.mealServiceDietInfo[1].row[0];
                let menu = meal.DDISH_NM
                    .replace(/<br\/>/g, '\n')
                    .replace(/\./g, '')
                    .replace(/ìš°ìœ \s*\(\d+\)/g, '')
                    .replace(/\s{2,}/g, '\n')
                    .trim();

                const text = `\n\nğŸ½ï¸ [${meal.MMEAL_SC_NM}] ${meal.MLSV_YMD}\n${menu}`;
                contentInput.value += text;
                alert("ê¸‰ì‹ ì •ë³´ê°€ ê¸€ ë‚´ìš©ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            })
            .catch(err => {
                alert(err.message || "ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            });
    }
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³µìœ  ë§í¬ í™•ì¸
    window.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const postTimestamp = urlParams.get("post");

        if (postTimestamp) {
            await showSinglePost(postTimestamp);
        } else {
            switchPage("home"); // ê¸°ë³¸ ë©”ì¸ í˜ì´ì§€
        }
    });

    async function showSinglePost(timestamp) {
        // posts ì•„ë˜ ëª¨ë“  ì¹´í…Œê³ ë¦¬ íƒìƒ‰
        const categoriesSnap = await db.ref("posts").once("value");
        const categories = categoriesSnap.val() || {};

        let foundPost = null;

        for (const category in categories) {
            for (const id in categories[category]) {
                const post = categories[category][id];
                if (String(post.timestamp) === String(timestamp)) {
                    // ëŒ“ê¸€ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;

                    foundPost = { ...post, commentCount };
                    break;
                }
            }
            if (foundPost) break;
        }

        if (foundPost) {
            // ê¸°ì¡´ ì¹´ë“œ UI ëŒ€ì‹  ë°”ë¡œ ìƒì„¸ë³´ê¸° íŒì—…
            showDetail(foundPost);
            switchPage("home");
        } else {
            const postList = document.getElementById("postGrid");
            postList.innerHTML = "<p style='color: white;' >í•´ë‹¹ ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ :)</p>";
        }
    }

    //                   _ooOoo_
    //                  o8888888o
    //                  88" . "88
    //                  (| -_- |)
    //                  O\  =  /O
    //               ____/`---'\____
    //             .'  \\|     |//  `.
    //            /  \\|||  :  |||//  \
    //           /  _||||| -:- |||||-  \
    //           |   | \\\  -  /// |   |
    //           | \_|  ''\---/''  |   |
    //           \  .-\__  `-`  ___/-. /
    //         ___`. .'  /--.--\  `. . __
    //      ."" '<  `.___\_<|>_/___.'  >'"".
    //     | | :  `- \`.;`\ _ /`;.`/ - ` : | |
    //     \  \ `-.   \_ __\ /__ _/   .-` /  /
    //======`-.____`-.___\_____/___.-`____.-'======
    //                   `=---='
    //
    //^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //          ä½›ç¥–ä¿ä½‘           æ°¸æ— BUG
    //         God Bless        Never Crash

    //ä½›åŠ›åŠ è¢«ç¥ˆé¡˜æ–‡ é¡˜ä»¥æ­¤åŠŸå¾· æ‰€é–‹ç™¼ä¹‹ç¨‹å¼ ç™¼è¡Œç„¡ç¤™ã€€åˆ©ç›Šè¡†ç”Ÿ æ»…é™¤è«¸éšœã€€æˆå°±å–„æ³• åæ–¹ä¸‰ä¸–ä¸€åˆ‡ä½› è©è–©æ‘©è¨¶è–©ã€€æ‘©è¨¶èˆ¬è‹¥æ³¢ç¾…èœœ
</script>
</body>
</html>



