<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6-5 DNS Í≤åÏãúÌåê</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
    <link href='https://fonts.googleapis.com/css?family=Jua' rel='stylesheet'>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        #searchInput {
            width: 100%;
            max-width: 500px;
            padding: 12px 16px;
            margin: 20px auto;
            display: block;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #searchInput:focus {
            border-color: #6c63ff;
            outline: none;
            box-shadow: 0 0 5px rgba(108, 99, 255, 0.5);
        }
        .timestamp {
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Jua';
            /*font-size: 22px;*/
        }
        html, body {
            height: 100%;
            background-color: #2e5e2e;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .auth-bar {
            background-color: #222;
            color: white;
            padding: 10px 20px;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .auth-bar button {
            background-color: #ffda58;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .sidebar {
            width: 220px;
            background-color: #333;
            color: white;
            padding-top: 40px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        .sidebar.closed {
            transform: translateX(-220px);
        }
        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.6rem;
            font-weight: bold;
        }
        .sidebar a,
        #authSection button {
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
            border: none;
            background-color: transparent;
            text-align: left;
            width: 100%;
        }
        .sidebar a:hover,
        #authSection button:hover,
        .sidebar a.active {
            background-color: #555;
        }
        /* Î™®Î∞îÏùº Í∏∞Ï§Ä: ÏÇ¨Ïù¥ÎìúÎ∞î Í≤πÏπòÍ∏∞ */
        .main-content {
            margin-left: 0;
            flex: 1;
            background-color: #2e5e2e;
            border: 15px solid #8b5a2b;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            overflow-y: auto;
            position: relative;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            z-index: 1;
        }
        .main-content.sidebar-closed {
            margin-left: 0 !important;
        }
        .sidebar-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: #ffda58;
            color: #222;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 1.2rem;
            z-index: 200;
            cursor: pointer;
        }
        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
            color: white;
        }
        .post-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .post-it {
            background-color: #fff8b3;
            color: #333;
            padding: 15px;
            width: 180px;
            height: 150px;
            cursor: pointer;
            border-radius: 8px;
            position: relative;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
            transform: rotate(calc(-5deg + 10deg * var(--rand)));
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-image: repeating-linear-gradient(
                    180deg,
                    transparent,
                    transparent 28px,
                    #e1de8d 29px
            );
            user-select: none;
        }
        .post-it:hover {
            transform: scale(1.05) rotate(calc(-5deg + 10deg * var(--rand)));
        }
        .pin {
            width: 16px;
            height: 16px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        #authSection {
            margin-top: auto;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #authSection button {
            background-color: #ffda58;
            color: #222;
            border-radius: 5px;
            font-size: 1rem;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            border: none;
            transition: background-color 0.3s;
        }
        #authSection button:hover {
            background-color: #e6c850;
        }
        #userInfo {
            color: white;
            font-size: 0.9rem;
            text-align: center;
            word-break: break-word;
        }
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #ffda58;
            color: #222;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 101;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .modal-content h2 {
            margin-bottom: 15px;
        }
        .modal-content input,
        .modal-content textarea {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .modal-content button {
            background-color: #2e5e2e;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        .post-detail {
            display: none;
            background: white;
            color: black;
            padding: 40px;
            border-radius: 15px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            max-height: 90vh;
            user-select: text;
        }
        .likes-comments {
            margin-top: 15px;
        }

        #submitBtn {
            width : 100%;
        }
        .likes-comments button {
            margin-right: 10px;
            background: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1rem;
            user-select: none;
        }
        .action-buttons button {
            margin-right: 10px;
            background: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1rem;
            user-select: none;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ccc;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            cursor: pointer;
            line-height: 25px;
            text-align: center;
            padding: 0;
            user-select: none;
        }
    </style>
</head>
<body>

<!-- üîò ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Î≤ÑÌäº -->
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
<script>
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const main = document.getElementById("mainContent");
        sidebar.classList.toggle("closed");
        main.classList.toggle("sidebar-closed");
    }
</script>
<!-- Í∏∞Ï°¥ ÏÇ¨Ïù¥ÎìúÎ∞î -->
<div class="sidebar closed" id="sidebar">
    <h2>6-5 DNS</h2>
    <a id="menu-home" onclick="switchPage('home'); toggleSidebar()">üè† Ìôà</a>
    <a id="menu-popular" onclick="switchPage('popular'); toggleSidebar()">üî• Ïù∏Í∏∞Ïàú</a>
    <a id="menu-official" onclick="switchPage('official'); toggleSidebar()">üì¢ Í≥µÏãùÍ∏Ä</a>
    <a id="menu-new" onclick="switchPage('new'); toggleSidebar()">‚ùìÏ§ÄÎπÑÏ§ë</a>
    <a id="menu-admin" onclick="location.href = './admin.html';" hidden> üõ†Ô∏è Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</a>
    <div id="authSection">
        <br /><br /><a href="https://www.youtube.com/watch?v=jfbnnLQaPEE&list=RDjfbnnLQaPEE&start_radio=1">Made by. Arin<br />@RC9 Studio</a>
        <div style="font-size : 16px" id="userInfo"></div>
        <button id="loginBtn" onclick="signInWithGoogle()">Google Î°úÍ∑∏Ïù∏</button>
        <button id="logoutBtn" onclick="signOut()" style="display:none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
    </div>
</div>

<!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
<div class="main-content sidebar-closed" id="mainContent">
    <!-- Ïù¥Ìïò Í∏∞Ï°¥ ÏΩîÎìú ÎèôÏùº -->
    <h1>6-5 DNS Í≤åÏãúÌåê</h1>
    <!--    <input-->
    <!--            type="text"-->
    <!--            id="searchInput"-->
    <!--            placeholder="Ï†úÎ™©ÏúºÎ°ú Í≤ÄÏÉâÌï¥ Î≥¥ÏÑ∏Ïöî"-->
    <!--    />-->
    <div class="post-grid" id="postGrid"></div>
    <button class="fab" onclick="openModal()">+</button>
</div>

<div class="modal" id="writeModal">
    <div class="modal-content">
        <h2 id="modalTitle">Í∏ÄÏì∞Í∏∞</h2>
        <input type="text" id="titleInput" placeholder="Ï†úÎ™©" required />
        <input type="url" id="imageInput" placeholder="Ïù¥ÎØ∏ÏßÄ/Ïú†ÌäúÎ∏å ÎèôÏòÅÏÉÅ ÎßÅÌÅ¨ (ÏÑ†ÌÉù)" />
        <textarea id="contentInput" placeholder="ÎÇ¥Ïö© ÏûÖÎ†•" rows="5"></textarea>
        <div style="margin-top: 10px;">
            <label for="mealDate">üç± Í∏âÏãù Ï∂îÍ∞Ä: </label>
            <input type="date" id="mealDate" />
            <button onclick="addMealToContent()">Ï∂îÍ∞Ä</button>
            <br />
            <br />
            <hr>
        </div>
        <div style="margin-top: 10px;">
            <!--      <label class="flex items-center mt-2">-->
            <!--        <input type="checkbox" id="isOfficialPost" class="mr-2"> Í≥µÏãù Í∏ÄÎ°ú Îì±Î°ù-->
            <!--      </label>-->
        </div>
        <button id="submitBtn" onclick="submitPost()">Ïò¨Î¶¨Í∏∞</button>
    </div>
</div>

<div class="post-detail" id="postDetail"></div>
<!-- Ïã†Í≥† Î™®Îã¨ -->
<!-- HTML Î∂ÄÎ∂Ñ -->

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    emailjs.init("WPR5GJnYFNbdzpDoh");
    function closeDetail() {
        document.getElementById("postDetail").style.display = "none";
        editingPostId = null;
    }
    // Ïã†Í≥† ÎåÄÏÉÅ Ï†ïÎ≥¥ Ï†ÄÏû•Ïö© Ï†ÑÏó≠ Î≥ÄÏàò
    let reportingPost = null;

    function openReportModal(postId, title) {
        closeDetail();
        reportingPost = { id: postId, title };
        document.getElementById("reportReason").value = "";
        document.getElementById("reportModal").style.display = "block";
    }


    function submitReport() {
        const reason = document.getElementById("reportReason").value.trim();
        if (!reason) {
            alert("Ïã†Í≥† ÏÇ¨Ïú†Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");
            return;
        }

        if (!currentUser || !reportingPost) {
            alert("Ïã†Í≥† Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            return;
        }

        const templateParams = {
            post_title: reportingPost.title,
            post_id: reportingPost.id,
            reason: reason,
            reporter: currentUser.displayName || currentUser.email || "Ïïå Ïàò ÏóÜÏùå",
            reporter_email: currentUser.email || "ÏóÜÏùå" ,
            email : "lvc.app.center@gmail.com"
        };

        emailjs.send('service_2mhgog9', 'template_mmrhzsu', templateParams, 'WPR5GJnYFNbdzpDoh')
            .then(() => {
                alert("Ïã†Í≥†Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.");
                document.getElementById("reportModal").style.display = "none";
                // document.getElementById("detailModal").style.display = "none";
            })
            .catch(error => {
                console.error("Ïã†Í≥† Ï†ÑÏÜ° Ïã§Ìå®:", error);
                alert("Ïã†Í≥† Ï≤òÎ¶¨ Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            });
        // ‚Üê Ïù¥ Îã´Îäî Ï§ëÍ¥ÑÌò∏Í∞Ä Î∞òÎìúÏãú ÌïÑÏöîÌï®

    }
</script>
<!-- Ïã†Í≥† Î™®Îã¨ -->
<!-- Í∏∞Ï°¥ HTML Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ -->
<div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; padding:20px; max-width:400px; margin:100px auto; border-radius:10px; position:relative;">
        <h3>Ïã†Í≥† ÏÇ¨Ïú† ÏûÖÎ†•</h3>
        <textarea id="reportReason" style="width:100%; height:100px;"></textarea>
        <br />
        <button onclick="submitReport()">Ï†úÏ∂ú</button>
        <button onclick="document.getElementById('reportModal').style.display = 'none';">Ï∑®ÏÜå</button>
    </div>
</div>

<!-- Ï∂îÍ∞Ä CSS -->
<style>
    /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
    #reportModal button {
        background-color: #FFDA58;
        color: #1a1a1a;
        font-family: 'Jua', sans-serif; /* Ï£ºÏïÑÏ≤¥ Ï†ÅÏö© */
        font-weight: 400;
        border: none;
        border-radius: 10px;
        padding: 10px 16px; /* Ï°∞Í∏à ÏûëÍ≤å */
        font-size: 15px;    /* Ï°∞Í∏à ÏûëÍ≤å */
        min-width: 90px;    /* ÎÑàÎπÑ ÏÇ¥Ïßù Ï§ÑÏûÑ */
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        transition: transform 0.08s ease, box-shadow 0.12s ease;
    }

    #reportModal button:active {
        transform: translateY(1px) scale(0.98);
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    /* Î™®Îã¨ ÎÇ¥Î∂Ä Ï†ïÎ†¨ */
    #reportModal > div {
        width: 90%;
        max-width: 400px;
        box-sizing: border-box;
    }

    /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
    @media (max-width: 480px) {
        #reportModal > div {
            margin: auto 16px;
            width: calc(100% - 32px);
            padding: 16px;
        }
        #reportModal textarea {
            height: 140px;
            font-size: 15px;
        }
        #reportModal button {
            width: 100%;
            font-size: 16px;
            padding: 12px;
            margin-top: 8px;
        }
    }
</style>
<script src="./ban.js">
</script>
<script>
    window.onload = function () {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const formattedToday = `${yyyy}-${mm}-${dd}`;
        document.getElementById('mealDate').value = formattedToday;
    };
</script>

<script>
    let userIp = "0.0.0.0";

    fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => userIp = data.ip)
        .catch(err => console.warn("IP Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err));

    // Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
        apiKey: "AIzaSyBfXN5Gy6KX1ThZ92zDY7MXrMMzMF2Ceqo",
        authDomain: "boofuck-dns.firebaseapp.com",
        databaseURL:
            "https://boofuck-dns-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "boofuck-dns",
        storageBucket: "boofuck-dns.firebasestorage.app",
        messagingSenderId: "594205078724",
        appId: "1:594205078724:web:c364d1ba8cc2bd6d140591",
        measurementId: "G-1EX9H2KHDL",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentPage = "home";
    const likedSet = new Set();
    let currentUser = null;
    let editingPostId = null;

    // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïãú UI Î≥ÄÍ≤Ω
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        const userInfo = document.getElementById("userInfo");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        if (user) {
            const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
            const isAdmin = adminUIDs.includes(user.uid);
            const displayName = user.displayName || user.email;
            userInfo.textContent = `${displayName}${isAdmin ? " (Í¥ÄÎ¶¨Ïûê)" : ""}`;
            loginBtn.style.display = "none";
            logoutBtn.style.display = "block";
            const adminBtn = document.getElementById("menu-admin");
            if (isAdmin) {
                adminBtn.style.display = "block";
            } else {
                adminBtn.style.display = "none";
            }

        } else {
            userInfo.textContent = "Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.";
            loginBtn.style.display = "block";
            logoutBtn.style.display = "none";
        }
    });
    // jsonbinÏóêÏÑú Ï∞®Îã® Ïù¥Î©îÏùº Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò ÏòàÏ†ú
    async function fetchBlockedEmails() {
        const response = await fetch('https://api.jsonbin.io/v3/b/68989c58ae596e708fc6af4a/latest', {
            headers: {
                'X-Master-Key': '$2a$10$v8MnmFSL/GoywF.qohAheOJAFCQDPmBW20gtMMHbxdN/zrkvUU1MW'
            }
        });
        const data = await response.json();
        // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ïóê Îî∞Îùº Ï°∞Ï†ï ÌïÑÏöî (Ïòà: data.record.blockedEmails)
        return data.record.blockedEmails || [];
    }

    // Firebase Ï¥àÍ∏∞ÌôîÎäî Ïù¥ÎØ∏ ÎêòÏñ¥ ÏûàÎã§Í≥† Í∞ÄÏ†ï

    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            try {
                const blockedEmails = await fetchBlockedEmails();
                const userEmail = user.email.toLowerCase();
                const isBlocked = blockedEmails.some(email => email.toLowerCase() === userEmail);

                if (isBlocked) {
                    alert('Ï†ïÏßÄÎêú Í≥ÑÏ†ïÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    await firebase.auth().signOut();
                    // ÏõêÌïúÎã§Î©¥ Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ÎèÑ Í∞ÄÎä•
                    // window.location.href = '/login.html';
                } else {
                    // Ï†ïÏÉÅ Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
                    console.log('Ï†ïÏÉÅ ÏÇ¨Ïö©Ïûê:', userEmail);
                }
            } catch (error) {
                console.error('Ï∞®Îã® Ïù¥Î©îÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò:', error);
            }
        }
    });


    // Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏
    function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(alert);
    }

    const postListElement = document.getElementById('postList');
    const searchInput = document.getElementById('searchInput');

    let allPosts = [];

    // üî• Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞
    db.ref("posts").on("value", (snapshot) => {
        const data = snapshot.val();
        allPosts = [];

        for (let id in data) {
            allPosts.push({
                id: id,
                ...data[id],
            });
        }

    });

    // // üîç Î†åÎçîÎßÅ + Í≤ÄÏÉâ
    // function renderPosts(posts) {
    //   // postListElement.innerHTML = "";
    //   posts.forEach((post) => {
    //     const li = document.createElement("li");
    //     li.innerHTML = `<strong>${post.title}</strong><br>${post.content}`;
    //     postListElement.appendChild(li);
    //   });
    // }



    // Î°úÍ∑∏ÏïÑÏõÉ
    function signOut() {
        auth.signOut().catch(alert);
    }

    // ÌéòÏù¥ÏßÄ Ï†ÑÌôò Î∞è Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞
    async function switchPage(page) {
        const postList = document.getElementById("postGrid");
        postList.innerHTML = "";

        if (page === "official") {
            const snapshot = await db.ref("posts").once("value");
            const data = snapshot.val() || {};

            let allPosts = Object.entries(data).flatMap(([board, posts]) =>
                Object.entries(posts).map(([id, post]) => ({
                    id,
                    ...post,
                }))
            );

            // ‚úÖ Ïù¥ Î∂ÄÎ∂ÑÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïú†Ìö®ÌïúÏßÄ Î®ºÏ†Ä ÌôïÏù∏Ìï©ÎãàÎã§.
            allPosts = allPosts.filter(post => post && typeof post === 'object');

            allPosts = await Promise.all(
                allPosts.map(async (post) => {
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;
                    return { ...post, commentCount };
                })
            );

            // ÌïÑÌÑ∞ÎßÅ Ï†ÑÏóê Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨Î•º Î®ºÏ†Ä ÏàòÌñâÌñàÏúºÎØÄÎ°ú, Ïù¥ ÌïÑÌÑ∞Îäî Í∑∏ÎåÄÎ°ú Îë°ÎãàÎã§.
            allPosts = allPosts.filter(
                (post) => post.title?.includes("[Í≥µÏãù]") || post.content?.includes("[Í≥µÏãù]")
            );

            allPosts.sort((a, b) => (b.likes || 0) + (b.commentCount || 0) - (a.likes || 0) - (a.commentCount || 0));
            allPosts.forEach(createPostCard);
        }   if (page === "popular") {
            // Î™®Îì† Í≤åÏãúÌåê Í∏Ä Ìï©Ï≥êÏÑú Ïù∏Í∏∞Í∏Ä Í∏∞Ï§Ä Ï†ïÎ†¨
            const boards = ["home", "new", "official"];
            let allPosts = [];

            for (const board of boards) {
                const snapshot = await db.ref(`posts/${board}`).once("value");
                const data = snapshot.val() || {};
                const posts = Object.values(data);
                allPosts = allPosts.concat(posts);
            }

            // ÎåìÍ∏Ä Ïàò Ìè¨Ìï®
            allPosts = await Promise.all(
                allPosts.map(async (post) => {
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;
                    return { ...post, commentCount };
                })
            );

            // Ï¢ãÏïÑÏöî + ÎåìÍ∏Ä Ïàò Ìï©ÏÇ∞ ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
            allPosts.sort(
                (a, b) => (b.likes || 0) + (b.commentCount || 0) - (a.likes || 0) - (a.commentCount || 0)
            );

            allPosts.forEach(createPostCard);
        } else {
            // ÌäπÏ†ï Í≤åÏãúÌåê Í∏Ä Î°úÎî©
            const snapshot = await db.ref(`posts/${page}`).once("value");
            const data = snapshot.val() || {};
            let posts = Object.values(data);

            posts = await Promise.all(
                posts.map(async (post) => {
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;
                    return { ...post, commentCount };
                })
            );

            posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            posts.forEach(createPostCard);
        }

        document.querySelectorAll(".sidebar a").forEach((a) => a.classList.remove("active"));
        const activeLink = document.getElementById(`menu-${page}`);
        if (activeLink) activeLink.classList.add("active");
    }

    //


    // Ìè¨Ïä§Ìä∏Ïûá Ïπ¥Îìú ÏÉùÏÑ± (ÏûëÏÑ±Ïûê ÎÖ∏Ï∂ú X)
    function createPostCard(post) {
        const card = document.createElement("div");
        card.className = "post-it";
        card.style.setProperty("--rand", Math.random().toFixed(100));
        card.innerHTML = `<div class="pin"></div>${post.title}`;
        card.onclick = () => showDetail(post);
        document.getElementById("postGrid").appendChild(card);
    }

    // ÏÉà Í∏ÄÏì∞Í∏∞ Î™®Îã¨ Ïó¥Í∏∞
    function openModal() {
        if (!currentUser) return alert("Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
        if (currentPage === "official")
            return alert("Í≥µÏãùÍ≤åÏãúÌåêÏóê Í≤åÏãúÎ¨º Í∏ÄÏùÑ Ïò¨Î¶¨Ïàò ÏóÜÏäµÎãàÎã§.");

        editingPostId = null; // ÏÉà Í∏ÄÏì∞Í∏∞ ÏÉÅÌÉú
        document.getElementById("modalTitle").textContent = "Í∏ÄÏì∞Í∏∞";
        document.getElementById("submitBtn").textContent = "Ïò¨Î¶¨Í∏∞";
        document.getElementById("titleInput").value = "";
        document.getElementById("contentInput").value = "";
        document.getElementById("imageInput").value = "";
        document.getElementById("writeModal").style.display = "flex";
    }

    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    window.onclick = function (event) {
        const modal = document.getElementById("writeModal");
        if (event.target === modal) modal.style.display = "none";
    };

    // Í∏ÄÏì∞Í∏∞ or ÏàòÏ†ï Ï†úÏ∂ú
    function submitPost() {
        const titleInput = document.getElementById("titleInput");
        const contentInput = document.getElementById("contentInput");
        const imageInput = document.getElementById("imageInput");
        const isOfficialPost = document.getElementById("isOfficialPost");
        const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
        const isOfficial = isOfficialPost?.checked && adminUIDs.includes(auth.currentUser.uid);
        const title = isOfficial
            ? `üì¢ [Í≥µÏãù] ${titleInput.value.trim()}`
            : titleInput.value.trim();
        const content = contentInput.value.trim();
        const image = imageInput.value.trim();

        if (!title) return alert("Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");

        const isAdmin = adminUIDs.includes(auth.currentUser.uid);


        //     async function checkWithGemini(text) {
        //       const API_KEY = "AIzaSyDSaoFO171HN6tx04abY3Em28ngIlxtk18";
        //       const MODEL_NAME = "gemini-2.0-flash";
        //
        //       // Í≤ÄÏó¥Ïö© ÏßàÎ¨∏ ÏòàÏãú ‚Äî Î∂ÄÏ†ÅÏ†àÌïú ÎÇ¥Ïö©Ïù∏ÏßÄ yes/noÎ°ú ÎãµÎ≥Ä ÏöîÏ≤≠
        //       const prompt = `ÏïÑÎûò Î¨∏Ïû•Ïù¥ Î∂ÄÏ†ÅÏ†àÌïòÍ±∞ÎÇò ÏöïÏÑ§, Í≥µÍ≤©Ï†ÅÏù∏ ÌëúÌòÑÏùÑ Ìè¨Ìï®ÌïòÎäîÏßÄ 'yes' ÎòêÎäî 'no'Î°úÎßå ÎåÄÎãµÌï¥Ï§ò:\n\n${text}`;
        //
        //       try {
        //         const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
        //           method: "POST",
        //           headers: { "Content-Type": "application/json" },
        //           body: JSON.stringify({
        //             contents: [{
        //               parts: [{
        //                 text: prompt
        //               }]
        //             }]
        //           })
        //         });
        //
        //         const data = await res.json();
        //         const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text.toLowerCase();
        //
        //         // "yes" Ìè¨Ìï®ÌïòÎ©¥ Î∂ÄÏ†ÅÏ†à ÌåêÎã®
        //         return reply.includes("yes");
        //         console.log(reply);
        // } catch (error) {
        //         console.error("Gemini API Ìò∏Ï∂ú Ïò§Î•ò:", error);
        //         // Ïò§Î•òÏãú ÏïàÏ†ÑÌïòÍ≤å Î∂ÄÏ†ÅÏ†à Ï≤òÎ¶¨ ÏïàÌï®(ÏõêÌïòÎäî ÎåÄÎ°ú ÏàòÏ†ï Í∞ÄÎä•)
        //         return false;
        //       }
        //     }
        //  checkWithGemini((content)
        if (!isAdmin) {
            for (let word of bannedWords) {
                if (title.includes(word) || content.includes(word)) {
                    alert(`Í∏àÏßÄÏñ¥ "${word}"Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Í≤åÏãúÍ∏ÄÏùÑ Îì±Î°ùÌï† Ïàò ÏóÜÏäµÎãàÎã§.`);
                    return;
                }
            }
        }

        const timestamp = Date.now();

        if (editingPostId !== null) {
            if (!title.includes(" (ÏàòÏ†ïÎê®)")) title += " (ÏàòÏ†ïÎê®)";
            db.ref(`posts/${currentPage}/${editingPostId}`)
                .once("value")
                .then((snapshot) => {
                    const oldPost = snapshot.val();
                    if (!oldPost) return alert("Í∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                    const updatedPost = {
                        ...oldPost,
                        title,
                        content,
                        image,
                        timestamp
                    };
                    db.ref(`posts/${currentPage}/${editingPostId}`).set(updatedPost);
                    switchPage(currentPage);
                    document.getElementById("writeModal").style.display = "none";
                });
        } else {
            const id = Date.now();
            const author = currentUser.displayName || currentUser.email || "ÏùµÎ™Ö";
            const post = {
                id,
                title,
                content,
                image,
                likes: 0,
                author,
                timestamp,
                authorUid: currentUser.uid,
                views: 0,  // ‚úÖ Ï°∞ÌöåÏàò ÌïÑÎìú Ï∂îÍ∞Ä
                ip: userIp  // ‚úÖ Ï†ÄÏû•,
            };
            db.ref(`posts/${currentPage}/${id}`).set(post);
            switchPage(currentPage);
            document.getElementById("writeModal").style.display = "none";
        }

        titleInput.value = "";
        contentInput.value = "";
        imageInput.value = "";
    }

    function renderPosts(posts) {
        posts.forEach(post => {
            const postDiv = document.createElement("div");
            postDiv.className = "post";

            const title = document.createElement("h3");
            title.textContent = post.title || "(Ï†úÎ™© ÏóÜÏùå)";
            postDiv.appendChild(title);

            const content = document.createElement("p");
            content.textContent = post.content || "";
            postDiv.appendChild(content);

            const author = document.createElement("small");
            author.textContent = post.author || "";
            postDiv.appendChild(author);

            postsDiv.appendChild(postDiv);
        });
    }
    // searchInput.addEventListener("input", function () {
    //   const keyword = searchInput.value.toLowerCase();
    //   const filtered = allPosts.filter(post =>
    //           post.title && post.title.toLowerCase().includes(keyword)
    //   );
    //   renderPosts(filtered);
    // });
    // üîç Í≤ÄÏÉâ Ïù¥Î≤§Ìä∏
    // ÎØ∏ÎîîÏñ¥ Î†åÎçîÎßÅ (Ïù¥ÎØ∏ÏßÄ, ÎèôÏòÅÏÉÅ, Ïò§ÎîîÏò§, Ïú†ÌäúÎ∏å)
    function renderMedia(url) {
        const ext = url.split(".").pop().toLowerCase();
        const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/;
        const match = url.match(ytRegex);
        if (match && match[1]) {
            return `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${match[1]}" frameborder="0" allowfullscreen style="margin:10px 0;"></iframe>`;
        }
        if (["mp4", "m4a"].includes(ext)) {
            return `<video controls style="max-width:100%; margin:10px 0;"><source src="${url}" type="video/${ext}">Not supported</video>`;
        }
        if (["mp3", "wav"].includes(ext)) {
            return `<audio controls style="width:100%; margin:10px 0;"><source src="${url}" type="audio/${ext}">Not supported</audio>`;
        }
        return `<img src="${url}" style="max-width:100%; margin:10px 0;">`;
    }

    // Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏Î≥¥Í∏∞ (ÏûëÏÑ±Ïûê ÌëúÏãú, Î≥∏Î¨∏ ÏàòÏ†ï Í∞ÄÎä•)
    async function showDetail(post) {
        const postRef = db.ref(`posts/${currentPage}/${post.id}`);

        try {
            let shouldIncreaseView = false;

            if (currentUser) {
                // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©Ïûê
                const viewRef = db.ref(`views/${post.id}/${currentUser.uid}`);
                const viewSnapshot = await viewRef.once("value");
                if (!viewSnapshot.exists()) {
                    await viewRef.set(true);
                    shouldIncreaseView = true;
                }
            } else {
                // ÎπÑÌöåÏõê ÏÇ¨Ïö©ÏûêÏùò Ï°∞Ìöå Í∏∞Î°ùÏùÄ localStorageÏóê Ï†ÄÏû•
                const viewedPosts = JSON.parse(localStorage.getItem("viewedPosts") || "{}");
                if (!viewedPosts[post.id]) {
                    viewedPosts[post.id] = true;
                    localStorage.setItem("viewedPosts", JSON.stringify(viewedPosts));
                    shouldIncreaseView = true;
                }
            }

            // Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä (ÏµúÏ¥à 1ÌöåÎßå)
            if (shouldIncreaseView) {
                await postRef.child('views').transaction(current => (current || 0) + 1);
            }

            // ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Îã§Ïãú Î∂àÎü¨Ïò§Í∏∞
            const snapshot = await postRef.once("value");
            if (snapshot.exists()) {
                post = snapshot.val();
            }


            const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
            const isAdmin = currentUser && adminUIDs.includes(currentUser.uid);
            const deleteBtn = isAdmin ? `<button onclick="deletePost(${post.id})" style="float:right; color:red;">üóëÔ∏è ÏÇ≠Ï†ú</button>` : "";
            const detail = document.getElementById("postDetail");
            const date = post.timestamp
                ? new Date(post.timestamp).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
                : "Ïïå Ïàò ÏóÜÏùå";

            const timestampHtml = `<div class="timestamp"><b>ÏûëÏÑ± ÏãúÍ∞Å:</b> ${date}</div>`;
            const maskedIp = post.ip
                ? post.ip.split('.').slice(0, 2).join('.') + '.*.*'
                : '?.?.*.*';
            // Í∏∞Ï°¥ ÏÉÅÏÑ∏ HTML ÏïàÏóê ÏÇΩÏûÖ
            function formatAuthorName(rawName) {
                const match = rawName.match(/^605\d{2}(.*)$/);
                return match ? match[1].trim() : rawName;
            }
            function openReportModal(postId, title) {
                closeDetail();
                reportingPost = { id: postId, title };
                document.getElementById("reportReason").value = "";
                document.getElementById("reportModal").style.display = "block";
            }
            detail.innerHTML = `
        <button class="close-btn" onclick="closeDetail()">√ó</button>
        <h2>${escapeHtml(post.title)}</h2>
        ${deleteBtn}
        ${post.image ? renderMedia(post.image) : ""}
        <p style="white-space: pre-wrap;">${escapeHtml(post.content)}</p><br />
        <div style="font-size : 15px  "> Ï°∞ÌöåÏàò ${post.views || 0}Ìöå<br /><b>ÏûëÏÑ±Ïûê:</b> ${escapeHtml(formatAuthorName(post.author || "ÏùµÎ™Ö"))} (${maskedIp})</div>
        ${timestampHtml}
        <div style="margin-top: 10px;" class="action-buttons">
        <button id="like-btn-${post.id}" onclick="likePost(${post.id})">‚ù§Ô∏è Ï¢ãÏïÑÏöî (<span id="like-count-${post.id}">${post.likes || 0}</span>)</button>
  <button onclick="navigator.clipboard.writeText(\`${window.location.origin}${window.location.pathname}?post=${post.timestamp}\`).then(() => alert('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!'));">üîó Í≥µÏú†ÌïòÍ∏∞</button>
    <button onclick="openReportModal('${post.id}', '${post.title.replace(/'/g, "\\'")}')">üö® Ïã†Í≥†ÌïòÍ∏∞</button>
  </div>
        <div class="likes-comments">
         <div style="margin-top:20px;">
          <h3>üí¨ ÎåìÍ∏Ä</h3>
          <div id="comments-${post.id}" style="margin-bottom: 10px;"></div>
          <input id="comment-input-${post.id}" type="text" placeholder="ÎåìÍ∏Ä ÏûÖÎ†•" style="width: 80%; padding: 5px;" />
          <button onclick="addComment(${post.id})" style="padding: 5px 10px;">ÏûëÏÑ±</button>
        </div>
        </div>

      `;
            detail.style.display = "block";
            renderComments(post.id);
        } catch (error) {
            console.error("Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä Ï§ë Ïò§Î•ò:", error);
            alert("Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        }
    }

    // HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ìï®Ïàò (XSS Î∞©ÏßÄ)
    function escapeHtml(text) {
        if (!text) return "";
        return text
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Ï¢ãÏïÑÏöî ÎàÑÎ•¥Í∏∞
    function likePost(id) {
        if (!currentUser) return alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ï¢ãÏïÑÏöîÎ•º ÎàåÎü¨Ï£ºÏÑ∏Ïöî.");
        if (likedSet.has(id)) return alert("Ïù¥ÎØ∏ Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ•¥ÏÖ®Ïñ¥Ïöî!");
        likedSet.add(id);

        // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä Ïù∏Í∏∞Í∏ÄÏùº Í≤ΩÏö∞, Í∞Å Í≤åÏãúÌåê Ï§ë Ïñ¥Îäê Í≤ÉÏù∏ÏßÄ Ï∞æÏïÑÏïº Ìï®
        // Í∞ÑÎã®Ìûà ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∏∞Ï§ÄÏúºÎ°úÎßå Ï≤òÎ¶¨ (Î≥µÏû°ÎèÑ Í≥†Î†§)
        const ref = db.ref(`posts/${currentPage}/${id}/likes`);
        ref
            .transaction((currentLikes) => {
                return (currentLikes || 0) + 1;
            })
            .then(() => {
                // Ï¢ãÏïÑÏöî Ïπ¥Ïö¥Ìä∏ Ï¶âÏãú UI Î∞òÏòÅ
                const likeCountSpan = document.getElementById(`like-count-${id}`);
                if (likeCountSpan) {
                    likeCountSpan.innerText = Number(likeCountSpan.innerText) + 1;
                }
                switchPage(currentPage);
            });
    }

    // ÎåìÍ∏Ä ÏûëÏÑ± (ÎåìÍ∏ÄÏùÄ { author, text } Í∞ùÏ≤¥Î°ú Ï†ÄÏû•)
    function addComment(id) {
        if (!currentUser) return alert("Î°úÍ∑∏Ïù∏ ÌõÑ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.");
        const input = document.getElementById(`comment-input-${id}`);
        const text = input.value.trim();
        if (!text) return;
            for (let word of bannedWords) {
                if (text.includes(word) || text.includes(word)) {
                    alert(`Í∏àÏßÄÏñ¥ "${word}"Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Í≤åÏãúÍ∏ÄÏùÑ Îì±Î°ùÌï† Ïàò ÏóÜÏäµÎãàÎã§.`);
                    return;
            }
        }
        const commentData = {
            author: currentUser.displayName || currentUser.email || "ÏùµÎ™Ö",
            text,
        };

        db.ref(`comments/${id}`).push(commentData).then(() => {
            input.value = "";
            renderComments(id);
        });
    }

    // ÎåìÍ∏Ä Îã§Ïãú Î†åÎçî (Ïã§Ï†úÎ°ú ÏÉÅÏÑ∏Î≥¥Í∏∞ÏóêÏÑúÎßå Ìò∏Ï∂úÎê®)
    function renderComments(postId) {
        function formatAuthorName(rawName) {
            const match = rawName.match(/^605\d{2}(.*)$/);
            return match ? match[1].trim() : rawName;
        }
        const commentsRef = db.ref(`comments/${postId}`);
        commentsRef.off(); // Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
        commentsRef.on("value", (snapshot) => {
            const commentsDiv = document.getElementById(`comments-${postId}`);
            commentsDiv.innerHTML = "";

            snapshot.forEach((childSnapshot) => {
                const comment = childSnapshot.val();
                const key = childSnapshot.key;

                const adminUIDs = ["iLhjGABJYAfdlQfhZeMcaJZm90A3", "brqrYfz4B5hgekWFZAPESnXQHcw1", "KesdyNvO1sUPJfRQxVC7bYINR4u2"];
                const isAdmin = currentUser && adminUIDs.includes(currentUser.uid);
                const isAuthor = currentUser && comment.uid === currentUser.uid;
                const showDelete = isAdmin || isAuthor;

                const commentElement = document.createElement("div");
                commentElement.innerHTML = `
          <b>${escapeHtml(formatAuthorName(comment.author || "ÏùµÎ™Ö"))}: ${escapeHtml(comment.text || "")}
          ${showDelete ? `<button onclick="deleteComment(${postId}, '${key}')" style="color:red; float:right;">ÏÇ≠Ï†ú</button>` : ""}
        `;
                commentsDiv.appendChild(commentElement);
            });
        });
    }

    function deleteComment(postId, commentId) {
        if (confirm("Ï†ïÎßê Ïù¥ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            db.ref(`comments/${postId}/${commentId}`).remove();
        }
    }

    function deletePost(postId) {
        if (!confirm("Ï†ïÎßê Ïù¥ Í≤åÏãúÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
        db.ref(`posts/${currentPage}/${postId}`).remove().then(() => {
            closeDetail();
            switchPage(currentPage); // ÏÉàÎ°úÍ≥†Ïπ®
        });
    }


    // ÏàòÏ†ï ÏãúÏûë: ÏÉÅÏÑ∏Î≥¥Í∏∞ Î™®Îã¨ÏóêÏÑú ÏàòÏ†ï Î≤ÑÌäº ÎàÑÎ•¥Î©¥ Í∏ÄÏì∞Í∏∞ Î™®Îã¨ Ïó¥Í∏∞ + Í∏∞Ï°¥ ÎÇ¥Ïö© ÏÑ∏ÌåÖ
    function startEditPost(postId) {
        if (!currentUser) return alert("Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
        // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóêÏÑú Ìï¥Îãπ Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞
        db.ref(`posts/${currentPage}/${postId}`)
            .once("value")
            .then((snapshot) => {
                const post = snapshot.val();
                if (!post) return alert("Í∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                if (
                    !(
                        currentUser.uid === post.authorUid ||
                        currentUser.email === post.author
                    )
                ) {
                    return alert("Î≥∏Ïù∏ Í∏ÄÎßå ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.");
                }
                editingPostId = postId;
                document.getElementById("modalTitle").textContent = "Í∏Ä ÏàòÏ†ï";
                document.getElementById("submitBtn").textContent = "ÏàòÏ†ïÏôÑÎ£å";
                document.getElementById("titleInput").value = post.title.replace(
                    " (ÏàòÏ†ïÎê®)",
                    ""
                );
                document.getElementById("contentInput").value = post.content;
                document.getElementById("imageInput").value = post.image || "";
                document.getElementById("writeModal").style.display = "flex";
                closeDetail();
            });
    }

    // Ï¥àÍ∏∞ ÌéòÏù¥ÏßÄ Î°úÎî©
</script>
<script>
    const API_KEY = "ecdd5e02250c425885ffc2da5742019b";
    const ATPT_OFCDC_SC_CODE = "B10";
    const SD_SCHUL_CODE = "7091380";

    function addMealToContent() {
        const dateInput = document.getElementById("mealDate");
        const contentInput = document.getElementById("contentInput");

        if (!dateInput.value) {
            alert("ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }

        const date = new Date(dateInput.value);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        const fullDate = `${y}${m}${d}`;

        const url = `https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${API_KEY}&ATPT_OFCDC_SC_CODE=${ATPT_OFCDC_SC_CODE}&SD_SCHUL_CODE=${SD_SCHUL_CODE}&MLSV_YMD=${fullDate}&Type=json`;

        fetch(url)
            .then(res => res.json())
            .then(json => {
                if (!json.mealServiceDietInfo || !json.mealServiceDietInfo[1]) {
                    throw new Error("ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÏóê Í∏âÏãù Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
                }

                const meal = json.mealServiceDietInfo[1].row[0];
                let menu = meal.DDISH_NM
                    .replace(/<br\/>/g, '\n')
                    .replace(/\./g, '')
                    .replace(/Ïö∞Ïú†\s*\(\d+\)/g, '')
                    .replace(/\s{2,}/g, '\n')
                    .trim();

                const text = `\n\nüçΩÔ∏è [${meal.MMEAL_SC_NM}] ${meal.MLSV_YMD}\n${menu}`;
                contentInput.value += text;
                alert("Í∏âÏãù Ï†ïÎ≥¥Í∞Ä Í∏Ä ÎÇ¥Ïö©Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.");
            })
            .catch(err => {
                alert(err.message || "Í∏âÏãù Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
            });
    }
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í≥µÏú† ÎßÅÌÅ¨ ÌôïÏù∏
    window.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const postTimestamp = urlParams.get("post");

        if (postTimestamp) {
            await showSinglePost(postTimestamp);
        } else {
            switchPage("home"); // Í∏∞Î≥∏ Î©îÏù∏ ÌéòÏù¥ÏßÄ
        }
    });

    async function showSinglePost(timestamp) {
        // posts ÏïÑÎûò Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉêÏÉâ
        const categoriesSnap = await db.ref("posts").once("value");
        const categories = categoriesSnap.val() || {};

        let foundPost = null;

        for (const category in categories) {
            for (const id in categories[category]) {
                const post = categories[category][id];
                if (String(post.timestamp) === String(timestamp)) {
                    // ÎåìÍ∏Ä Ïàò Í∞ÄÏ†∏Ïò§Í∏∞
                    const commentSnap = await db.ref(`comments/${post.id}`).once("value");
                    const commentCount = commentSnap.exists()
                        ? Object.keys(commentSnap.val()).length
                        : 0;

                    foundPost = { ...post, commentCount };
                    break;
                }
            }
            if (foundPost) break;
        }

        if (foundPost) {
            // Í∏∞Ï°¥ Ïπ¥Îìú UI ÎåÄÏã† Î∞îÎ°ú ÏÉÅÏÑ∏Î≥¥Í∏∞ ÌåùÏóÖ
            showDetail(foundPost);
            switchPage("home");
        } else {
            const postList = document.getElementById("postGrid");
            postList.innerHTML = "<p style='color: white;' >Ìï¥Îãπ Í≤åÏãúÍ∏ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ :)</p>";
        }
    }

    //                   _ooOoo_
    //                  o8888888o
    //                  88" . "88
    //                  (| -_- |)
    //                  O\  =  /O
    //               ____/`---'\____
    //             .'  \\|     |//  `.
    //            /  \\|||  :  |||//  \
    //           /  _||||| -:- |||||-  \
    //           |   | \\\  -  /// |   |
    //           | \_|  ''\---/''  |   |
    //           \  .-\__  `-`  ___/-. /
    //         ___`. .'  /--.--\  `. . __
    //      ."" '<  `.___\_<|>_/___.'  >'"".
    //     | | :  `- \`.;`\ _ /`;.`/ - ` : | |
    //     \  \ `-.   \_ __\ /__ _/   .-` /  /
    //======`-.____`-.___\_____/___.-`____.-'======
    //                   `=---='
    //
    //^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //          ‰ΩõÁ•ñ‰øù‰Ωë           Ê∞∏Êó†BUG
    //         God Bless        Never Crash

    //‰ΩõÂäõÂä†Ë¢´Á•àÈ°òÊñá È°ò‰ª•Ê≠§ÂäüÂæ∑ ÊâÄÈñãÁôº‰πãÁ®ãÂºè ÁôºË°åÁÑ°Á§ô„ÄÄÂà©ÁõäË°ÜÁîü ÊªÖÈô§Ë´∏Èöú„ÄÄÊàêÂ∞±ÂñÑÊ≥ï ÂçÅÊñπ‰∏â‰∏ñ‰∏ÄÂàá‰Ωõ Ëè©Ëñ©Êë©Ë®∂Ëñ©„ÄÄÊë©Ë®∂Ëà¨Ëã•Ê≥¢ÁæÖËúú
</script>
</body>
</html>



